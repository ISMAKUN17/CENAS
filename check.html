<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestión de Reservas</title>
<style>
  /* Estilos básicos para validación y modales */
  .availability-info { margin-top: 0.5em; font-weight: 600; }
  .available { color: green; }
  .limited { color: orange; }
  .full { color: red; }
  .error-message { color: red; font-size: 0.9em; margin-top: 0.2em; }
  .reservation-item { padding: 6px 10px; border-bottom: 1px solid #ddd; }
  .archived { opacity: 0.6; font-style: italic; }
  /* Modales básicos omitidos por brevedad */
</style>
</head>
<body>

<h1>Gestión de Reservas</h1>

<!-- Formulario de reserva -->
<form id="reservationForm">
  <div class="form-group">
    <label for="room">Habitación (4 dígitos):</label>
    <input type="number" id="room" required />
  </div>

  <div class="form-group">
    <label for="guest">Nombre del huésped:</label>
    <input type="text" id="guest" required />
  </div>

  <div class="form-group">
    <label for="place">Restaurante:</label>
    <select id="place" required>
      <option value="">Seleccione...</option>
      <option>El Patio</option>
      <option>Bluewater</option>
      <option>Bordeaux</option>
      <option>Himitsu</option>
      <option>Hibachi</option>
      <option>El Olio</option>
    </select>
  </div>

  <div class="form-group">
    <label for="time">Hora:</label>
    <select id="time" disabled required>
      <option value="">Seleccione un restaurante primero</option>
    </select>
  </div>

  <div class="form-group">
    <label for="pax">Cantidad de Personas:</label>
    <input type="number" id="pax" min="1" value="1" required />
    <div id="paxError" class="error-message"></div>
  </div>

  <div class="form-group">
    <label for="comment">Comentario:</label>
    <textarea id="comment"></textarea>
  </div>

  <button type="submit" id="submitReservationBtn">Registrar Reserva</button>
  <p id="operatingHoursMessage" style="color:red; display:none;">Solo se aceptan reservas de 7:00 AM a 4:30 PM</p>
</form>

<button id="addReservationBtn">Agregar Reserva</button>
<button id="viewSummaryBtn">Ver Resumen</button>
<button id="viewArchiveBtn">Ver Archivo</button>

<!-- Buscador reservas día -->
<div>
  <label for="reservationSearch">Buscar Reserva:</label>
  <input type="text" id="reservationSearch" placeholder="Buscar por habitación, huésped, restaurante, hora" />
</div>

<!-- Lista reservas día -->
<div id="reservationList"></div>
<p id="noReservationsMessage" style="display:none; font-style: italic;"></p>

<!-- Historial por habitación -->
<section>
  <h2>Historial por Habitación</h2>
  <input type="number" id="roomHistorySearch" placeholder="Número de habitación 4 dígitos" />
  <div id="roomHistoryResults" style="margin-top: 10px;"></div>
</section>

<!-- Modal Validación Nombre -->
<div id="validationModal" style="display:none;">
  <div>
    <h3>Validar Reserva</h3>
    <label for="validatorNameInput">Nombre quien registra:</label>
    <input type="text" id="validatorNameInput" />
    <button id="confirmValidationBtn">Confirmar</button>
    <button id="cancelValidationBtn">Cancelar</button>
  </div>
</div>

<!-- Modal Resumen -->
<div id="summaryModal" style="display:none;">
  <h3 id="summaryTitle"></h3>
  <div id="summaryContent" style="max-height: 400px; overflow-y: auto;"></div>
  <p id="overallPaxTotal"></p>
  <button id="closeSummaryBtn">Cerrar</button>
</div>

<!-- Modal Archivo -->
<div id="archiveModal" style="display:none;">
  <h3 id="archiveTitle">Reservas Archivadas</h3>
  <input type="text" id="archiveSearch" placeholder="Buscar en archivo..." />
  <div id="archiveListContent" style="max-height: 400px; overflow-y: auto;"></div>
  <p id="noArchivedReservationsMessage" style="display:none; font-style: italic;"></p>
  <button id="closeArchiveBtn">Cerrar</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, onValue, get, runTransaction, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyALR-b68phh_u92V3rw9B9Ei7FcexU2xc8",
    authDomain: "proyectos17-98695.firebaseapp.com",
    projectId: "proyectos17-98695",
    storageBucket: "proyectos17-98695.firebasestorage.app",
    messagingSenderId: "951673973410",
    appId: "1:951673973410:web:4bc355e825cf86308645fb",
    measurementId: "G-6YK06W16FZ"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  document.addEventListener('DOMContentLoaded', () => {
    // Referencias DOM
    const addReservationBtn = document.getElementById('addReservationBtn');
    const viewSummaryBtn = document.getElementById('viewSummaryBtn');
    const viewArchiveBtn = document.getElementById('viewArchiveBtn');
    const reservationForm = document.getElementById('reservationForm');
    const placeSelect = document.getElementById('place');
    const timeSelect = document.getElementById('time');
    const paxInput = document.getElementById('pax');
    const availabilityInfo = document.getElementById('availabilityInfo');
    const paxError = document.getElementById('paxError');
    const reservationListDiv = document.getElementById('reservationList');
    const noReservationsMessage = document.getElementById('noReservationsMessage');
    const reservationSearchInput = document.getElementById('reservationSearch');
    const submitReservationBtn = document.getElementById('submitReservationBtn');
    const operatingHoursMessage = document.getElementById('operatingHoursMessage');
    const validationModal = document.getElementById('validationModal');
    const validatorNameInput = document.getElementById('validatorNameInput');
    const confirmValidationBtn = document.getElementById('confirmValidationBtn');
    const cancelValidationBtn = document.getElementById('cancelValidationBtn');

    const summaryModal = document.getElementById('summaryModal');
    const summaryTitle = document.getElementById('summaryTitle');
    const summaryContent = document.getElementById('summaryContent');
    const overallPaxTotal = document.getElementById('overallPaxTotal');
    const closeSummaryBtn = document.getElementById('closeSummaryBtn');

    const archiveModal = document.getElementById('archiveModal');
    const archiveSearchInput = document.getElementById('archiveSearch');
    const archiveListContent = document.getElementById('archiveListContent');
    const noArchivedReservationsMessage = document.getElementById('noArchivedReservationsMessage');
    const closeArchiveBtn = document.getElementById('closeArchiveBtn');

    const roomHistorySearch = document.getElementById('roomHistorySearch');
    const roomHistoryResults = document.getElementById('roomHistoryResults');

    // Variables y constantes
    let reservations = [];
    let archivedReservations = [];
    let currentReservationData = null;
    let lastAccessDate = localStorage.getItem('lastAccessDate');

    const restaurantTimes = {
      "El Patio": ["18:00", "21:00"],
      "Bluewater": ["18:00", "21:00"],
      "Bordeaux": ["18:00", "21:00"],
      "Himitsu": ["18:00", "21:00"],
      "Hibachi": ["17:30", "18:45", "20:00", "21:15"],
      "El Olio": ["18:30", "21:00"]
    };

    const restaurantPaxLimits = {
      "El Patio": 8,
      "Bluewater": 8,
      "Bordeaux": 6,
      "Himitsu": 8,
      "Hibachi": 10,
      "El Olio": 8
    };

    // Funciones auxiliares de fecha y hora
    function getTodayDateString() {
      const today = new Date();
      return today.toISOString().slice(0, 10);
    }

    function getFormattedDate(dateString) {
      if (!dateString) return 'Fecha desconocida';
      const date = new Date(dateString + 'T12:00:00');
      return date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    function convertTo12HourFormat(time24h) {
      const [hours, minutes] = time24h.split(':');
      const hour = parseInt(hours, 10);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${minutes} ${ampm}`;
    }

    function getTodayDateFormatted() {
      const today = new Date();
      return today.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // --- Validar horario operativo ---
    function checkOperatingHours() {
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      const startMinutes = 7 * 60;
      const endMinutes = 16 * 60 + 30;
      const isOpen = currentMinutes >= startMinutes && currentMinutes <= endMinutes;

      submitReservationBtn.disabled = !isOpen;
      operatingHoursMessage.style.display = isOpen ? 'none' : 'block';

      return isOpen;
    }

    // --- Cargar y archivar reservas ---
    async function loadAndArchiveReservations() {
      const today = getTodayDateString();
      const dailyReservationsRef = ref(database, `dailyReservations/${today}`);
      const allArchivedReservationsRef = ref(database, 'archivedReservations');

      try {
        // Cargar reservas archivadas
        const archiveSnapshot = await get(allArchivedReservationsRef);
        archivedReservations = [];
        if (archiveSnapshot.exists()) {
          archiveSnapshot.forEach(dateNode => {
            dateNode.forEach(resNode => {
              archivedReservations.push({ id: resNode.key, ...resNode.val() });
            });
          });
        }

        // Archivar reservas del día anterior si cambió la fecha
        if (lastAccessDate && lastAccessDate !== today) {
          const previousDayReservationsRef = ref(database, `dailyReservations/${lastAccessDate}`);
          const previousDaySnapshot = await get(previousDayReservationsRef);

          if (previousDaySnapshot.exists()) {
            const previousDayData = previousDaySnapshot.val();
            const updates = {};
            for (const key in previousDayData) {
              const res = previousDayData[key];
              res.archiveDate = lastAccessDate;
              updates[`archivedReservations/${lastAccessDate}/${key}`] = res;
            }
            updates[`dailyReservations/${lastAccessDate}`] = null;
            await set(ref(database), updates);
            console.log(`Reservas del ${lastAccessDate} archivadas.`);
          }
          reservations = [];
        }

        // Actualizar último acceso
        localStorage.setItem('lastAccessDate', today);
        lastAccessDate = today;

        // Inicializar disponibilidad en Firebase para hoy (si no existe)
        for (const place in restaurantPaxLimits) {
          const times = restaurantTimes[place];
          for (const time of times) {
            const availRef = ref(database, `availability/${place}/${today}/${time}/remainingPax`);
            const snapshot = await get(availRef);
            if (!snapshot.exists()) {
              await set(availRef, restaurantPaxLimits[place]);
            }
          }
        }

        // Escuchar reservas del día actual
        onValue(dailyReservationsRef, snapshot => {
          const data = snapshot.val();
          reservations = [];
          if (data) {
            for (const key in data) {
              reservations.push({ id: key, ...data[key] });
            }
          }
          renderReservations();
          updateAvailabilityInfo();
          filterRoomHistorySearch();
        });

      } catch (error) {
        console.error("Error cargando reservas:", error);
        alert("Error al cargar reservas, intenta de nuevo.");
      }
      checkOperatingHours();
    }

    loadAndArchiveReservations();

    // --- Renderizar reservas ---
    function renderReservations(filteredReservations = reservations) {
      filteredReservations.sort((a,b) => {
        const rCompare = a.place.localeCompare(b.place);
        if (rCompare !== 0) return rCompare;
        const tCompare = a.time.localeCompare(b.time);
        if (tCompare !== 0) return tCompare;
        return parseInt(a.room) - parseInt(b.room);
      });

      reservationListDiv.innerHTML = '';
      if (filteredReservations.length === 0) {
        noReservationsMessage.style.display = 'block';
        noReservationsMessage.textContent = reservations.length === 0 ? 
          'No hay reservas programadas para hoy.' : 
          'No se encontraron reservas.';
      } else {
        noReservationsMessage.style.display = 'none';
        filteredReservations.forEach(res => {
          const div = document.createElement('div');
          div.className = 'reservation-item';
          div.innerHTML = `<strong>${res.room}</strong> - ${res.guest} | ${res.place} - ${convertTo12HourFormat(res.time)} | ${res.pax} PAX`;
          reservationListDiv.appendChild(div);
        });
      }
    }

    // --- Renderizar reservas archivadas ---
    function renderArchivedReservations(filteredArchived = archivedReservations) {
      filteredArchived.sort((a,b) => {
        const dCompare = new Date(b.archiveDate) - new Date(a.archiveDate);
        if (dCompare !== 0) return dCompare;
        const rCompare = a.place.localeCompare(b.place);
        if (rCompare !== 0) return rCompare;
        return a.time.localeCompare(b.time);
      });

      archiveListContent.innerHTML = '';
      if (filteredArchived.length === 0) {
        noArchivedReservationsMessage.style.display = 'block';
        noArchivedReservationsMessage.textContent = archivedReservations.length === 0 ? 
          'No hay reservas archivadas.' : 
          'No se encontraron reservas archivadas.';
      } else {
        noArchivedReservationsMessage.style.display = 'none';
        filteredArchived.forEach(res => {
          const div = document.createElement('div');
          div.className = 'reservation-item archived';
          div.innerHTML = `<strong>${res.room}</strong> - ${res.guest} | ${res.place} - ${convertTo12HourFormat(res.time)} | ${res.pax} PAX | Archivado: ${getFormattedDate(res.archiveDate)}`;
          archiveListContent.appendChild(div);
        });
      }
    }

    // --- Filtrar reservas día ---
    reservationSearchInput.addEventListener('input', () => {
      const term = reservationSearchInput.value.trim().toLowerCase();
      if (!term) {
        renderReservations();
        return;
      }
      const filtered = reservations.filter(r =>
        r.room.includes(term) ||
        r.guest.toLowerCase().includes(term) ||
        r.place.toLowerCase().includes(term) ||
        convertTo12HourFormat(r.time).toLowerCase().includes(term)
      );
      renderReservations(filtered);
    });

    // --- Filtrar reservas archivadas ---
    archiveSearchInput.addEventListener('input', () => {
      const term = archiveSearchInput.value.trim().toLowerCase();
      if (!term) {
        renderArchivedReservations();
        return;
      }
      const filtered = archivedReservations.filter(r =>
        r.room.includes(term) ||
        r.guest.toLowerCase().includes(term) ||
        r.place.toLowerCase().includes(term) ||
        convertTo12HourFormat(r.time).toLowerCase().includes(term) ||
        getFormattedDate(r.archiveDate).toLowerCase().includes(term) ||
        r.archiveDate.includes(term)
      );
      renderArchivedReservations(filtered);
    });

    // --- Filtrar historial por habitación ---
    roomHistorySearch.addEventListener('input', () => {
      filterRoomHistorySearch();
    });

    function filterRoomHistorySearch() {
      const roomNum = roomHistorySearch.value.trim();
      if (roomNum.length !== 4) {
        roomHistoryResults.innerHTML = '';
        return;
      }
      renderRoomHistory(roomNum);
    }

    function renderRoomHistory(roomNum) {
      const matches = [
        ...reservations.filter(r => r.room === roomNum),
        ...archivedReservations.filter(r => r.room === roomNum),
      ];
      if (!matches.length) {
        roomHistoryResults.innerHTML = `<p>No hay historial para la habitación ${roomNum}.</p>`;
        return;
      }
      roomHistoryResults.innerHTML = matches.map(r => 
        `<div class="reservation-item${r.archiveDate ? ' archived' : ''}">
          <strong>${r.place}</strong> - ${convertTo12HourFormat(r.time)} - ${r.pax} PAX
          ${r.archiveDate ? `<span> (Archivado: ${getFormattedDate(r.archiveDate)})</span>` : ''}
        </div>`
      ).join('');
    }

    // --- Actualizar opciones hora según restaurante ---
    placeSelect.addEventListener('change', () => {
      const restaurant = placeSelect.value;
      updateTimeOptions(restaurant);
      updateAvailabilityInfo();
    });

    function updateTimeOptions(restaurant) {
      timeSelect.innerHTML = '';
      if (restaurant && restaurantTimes[restaurant]) {
        timeSelect.disabled = false;
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Seleccione hora';
        timeSelect.appendChild(defaultOption);

        restaurantTimes[restaurant].forEach(time => {
          const option = document.createElement('option');
          option.value = time;
          option.textContent = convertTo12HourFormat(time);
          timeSelect.appendChild(option);
        });
      } else {
        timeSelect.disabled = true;
        timeSelect.innerHTML = '<option value="">Seleccione un restaurante primero</option>';
      }
    }

    timeSelect.addEventListener('change', updateAvailabilityInfo);
    paxInput.addEventListener('input', updateAvailabilityInfo);

    // --- Actualizar disponibilidad y validar pax ---
    async function updateAvailabilityInfo() {
      const restaurant = placeSelect.value;
      const time = timeSelect.value;
      let requestedPax = parseInt(paxInput.value) || 1;
      paxError.textContent = '';
      if (!restaurant || !time) {
        // No mostrar nada si no hay restaurante o hora
        return;
      }

      const today = getTodayDateString();
      const availRef = ref(database, `availability/${restaurant}/${today}/${time}/remainingPax`);
      let remainingPax = restaurantPaxLimits[restaurant];

      try {
        const snapshot = await get(availRef);
        if (snapshot.exists()) {
          remainingPax = snapshot.val();
        }
      } catch (error) {
        console.error("Error consultando disponibilidad:", error);
      }

      if (remainingPax <= 0) {
        paxError.textContent = '¡No hay espacios disponibles para esta hora!';
      } else if (requestedPax > remainingPax) {
        paxError.textContent = `Máximo ${remainingPax} personas disponibles.`;
      } else {
        paxError.textContent = '';
      }
    }

    // --- Validación visual de pax antes de enviar ---
    function validatePax() {
      return paxError.textContent === '';
    }

    // --- Formatear y validar campos antes de guardar ---
    reservationForm.addEventListener('submit', e => {
      e.preventDefault();

      if (!checkOperatingHours()) {
        alert('Solo se aceptan reservas entre 7:00 AM y 4:30 PM');
        return;
      }

      if (!validatePax()) {
        alert('Corrige la cantidad de personas según la disponibilidad.');
        return;
      }

      const room = document.getElementById('room').value.trim();
      if (room.length !== 4) {
        alert('La habitación debe tener 4 dígitos.');
        return;
      }

      currentReservationData = {
        room,
        guest: document.getElementById('guest').value.trim(),
        place: placeSelect.value,
        time: timeSelect.value,
        pax: parseInt(paxInput.value),
        comment: document.getElementById('comment').value.trim(),
        createdAt: new Date().toISOString(),
      };

      openValidationModal();
    });

    // --- Modal validación nombre quien registra ---
    function openValidationModal() {
      validationModal.style.display = 'block';
      validatorNameInput.value = '';
      validatorNameInput.focus();
    }

    function closeValidationModal() {
      validationModal.style.display = 'none';
      currentReservationData = null;
    }

    confirmValidationBtn.addEventListener('click', async () => {
      const validatorName = validatorNameInput.value.trim();
      if (!validatorName) {
        alert('Debe ingresar su nombre para validar la reserva.');
        return;
      }

      currentReservationData.validatorName = validatorName;
      await addReservation(currentReservationData);
      closeValidationModal();
      reservationForm.reset();
      timeSelect.disabled = true;
      paxError.textContent = '';
    });

    cancelValidationBtn.addEventListener('click', () => {
      closeValidationModal();
    });

    // --- Añadir reserva con transaction para evitar overbooking ---
    async function addReservation(data) {
      const today = getTodayDateString();
      const availabilityPath = `availability/${data.place}/${today}/${data.time}/remainingPax`;
      const availabilityRef = ref(database, availabilityPath);
      const reservationRef = ref(database, `dailyReservations/${today}`);

      try {
        const transactionResult = await runTransaction(availabilityRef, current => {
          if (current === null) {
            // Inicializar si no existe
            return restaurantPaxLimits[data.place] - data.pax;
          }
          if (current < data.pax) {
            // No hay espacio suficiente
            return;
          }
          return current - data.pax;
        });

        if (!transactionResult.committed) {
          alert('No hay suficientes espacios disponibles para esa hora.');
          return;
        }

        // Guardar reserva
        await push(reservationRef, data);
        alert('✅ Reserva registrada con éxito.');

      } catch (error) {
        console.error('Error al agregar reserva:', error);
        alert('Error al registrar reserva, intenta nuevamente.');
      }
    }

    // --- Mostrar resumen por restaurante ---
    viewSummaryBtn.addEventListener('click', () => {
      if (reservations.length === 0) {
        alert('No hay reservas para hoy.');
        return;
      }
      let summaryHTML = '';
      let overallTotal = 0;

      const grouped = {};

      reservations.forEach(r => {
        if (!grouped[r.place]) grouped[r.place] = [];
        grouped[r.place].push(r);
      });

      for (const place in grouped) {
        const count = grouped[place].length;
        const paxTotal = grouped[place].reduce((acc, r) => acc + r.pax, 0);
        overallTotal += paxTotal;

        summaryHTML += `<h4>${place} - ${count} reservas</h4>`;
        summaryHTML += `<ul>`;
        grouped[place].forEach(r => {
          summaryHTML += `<li>${r.room} - ${r.guest} - ${convertTo12HourFormat(r.time)} - ${r.pax} PAX</li>`;
        });
        summaryHTML += `</ul><p><strong>Total personas: ${paxTotal}</strong></p>`;
      }

      summaryTitle.textContent = `Resumen de reservas para ${getTodayDateFormatted()}`;
      summaryContent.innerHTML = summaryHTML;
      overallPaxTotal.textContent = `Personas en total: ${overallTotal}`;
      summaryModal.style.display = 'block';
    });

    closeSummaryBtn.addEventListener('click', () => {
      summaryModal.style.display = 'none';
    });

    // --- Mostrar archivo ---
    viewArchiveBtn.addEventListener('click', () => {
      renderArchivedReservations();
      archiveModal.style.display = 'block';
    });

    closeArchiveBtn.addEventListener('click', () => {
      archiveModal.style.display = 'none';
    });

    // --- Inicialización ---
    updateTimeOptions('');
    checkOperatingHours();

    // Actualizar disponibilidad periódicamente
    setInterval(checkOperatingHours, 60000);

  });
</script>
</body>
</html>
