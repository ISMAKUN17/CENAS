<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservas de Restaurantes</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Variables CSS para consistencia de diseño */
        :root {
            --primary-color: #66BB6A; /* Verde/teal claro, suave y acogedor */
            --secondary-color: #4DD0E1; /* Azul claro complementario */
            --accent-color: #FFB74D; /* Naranja suave para acentos */
            
            --background-color: #F5F8FA; /* Fondo muy claro, casi blanco */
            --card-background: #FFFFFF; /* Blanco puro para tarjetas */
            --text-color: #333333; /* Gris oscuro para texto principal */
            --light-text-color: #757575; /* Gris medio para texto secundario */
            --border-color: #CFD8DC; /* Gris/azul muy claro para bordes sutiles */

            --shadow-light: 0 3px 10px rgba(0, 0, 0, 0.07); /* Sombra más pequeña */
            --shadow-medium: 0 8px 25px rgba(0, 0, 0, 0.12); /* Sombra más pequeña */
            --border-radius-sm: 6px; /* Radio más pequeño */
            --border-radius-md: 12px; /* Radio más pequeño */
            --transition-speed: 0.3s; /* Transición un poco más rápida */
            --font-family-heading: 'Montserrat', sans-serif;
            --font-family-body: 'Open Sans', sans-serif;
            --white-color: #FFFFFF;
            --danger-color: #E57373; /* Rojo suave para mensajes de error/advertencia */
        }

        body {
            font-family: var(--font-family-body);
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 15px; /* Reducido */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            max-width: 1000px; /* Reducido */
            width: 100%;
            background-color: var(--card-background);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-medium);
            padding: 30px; /* Reducido */
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 30px; /* Reducido */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px; /* Reducido */
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px; /* Reducido */
        }

        .header h1 {
            font-family: var(--font-family-heading);
            margin: 0;
            color: var(--primary-color);
            font-size: 2.4em; /* Reducido */
            font-weight: 700;
            letter-spacing: -0.03em;
        }

        .header .buttons-group {
            display: flex;
            gap: 10px; /* Reducido */
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px; /* Reducido */
            border: none;
            border-radius: 30px; /* Reducido */
            font-size: 0.9em; /* Reducido */
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: var(--shadow-light);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 0.03em; /* Reducido */
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
        .btn-primary:hover {
            background-color: #5CB85C;
            transform: translateY(-2px); /* Reducido */
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background-color: var(--card-background);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }
        .btn-secondary:hover {
            background-color: var(--primary-color);
            color: var(--white-color);
            transform: translateY(-2px); /* Reducido */
            box-shadow: var(--shadow-medium);
        }

        .btn-submit {
            background-color: var(--accent-color);
            color: var(--white-color);
            grid-column: span 2;
            margin-top: 20px; /* Reducido */
        }
        .btn-submit:hover {
            background-color: #FFA726;
            transform: translateY(-2px); /* Reducido */
            box-shadow: var(--shadow-medium);
        }

        .btn:disabled {
            background-color: #E0E0E0;
            color: #A0A0A0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.1fr 1.9fr;
            gap: 30px; /* Reducido */
        }

        section {
            background-color: var(--card-background);
            padding: 25px; /* Reducido */
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
        }

        section h2 {
            font-family: var(--font-family-heading);
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px; /* Reducido */
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px; /* Reducido */
            font-size: 1.6em; /* Reducido */
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px; /* Reducido */
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group-full {
            grid-column: span 2;
        }

        label {
            margin-bottom: 8px; /* Reducido */
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.85em; /* Reducido */
            text-transform: uppercase;
            letter-spacing: 0.02em; /* Reducido */
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: calc(100% - 16px); /* Ajustado para padding reducido */
            padding: 8px 8px; /* Reducido */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 0.9em; /* Reducido */
            color: var(--text-color);
            background-color: var(--background-color);
            transition: all var(--transition-speed) ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.1); /* Sombra de enfoque más pequeña */
            background-color: var(--white-color);
        }

        textarea {
            resize: vertical;
            min-height: 50px; /* Reducido */
        }

        .availability-info {
            font-size: 0.8em; /* Reducido */
            margin-top: 8px; /* Reducido */
            min-height: 1.6em; /* Reducido */
            font-weight: 500;
            padding-left: 5px;
        }

        .availability-info.available {
            color: var(--primary-color);
        }

        .availability-info.limited {
            color: var(--accent-color);
        }

        .availability-info.full {
            color: var(--danger-color);
        }

        .operating-hours-message {
            grid-column: span 2;
            text-align: center;
            font-size: 0.85em; /* Reducido */
            color: var(--danger-color);
            background-color: rgba(229, 115, 115, 0.15);
            border: 1px solid var(--danger-color);
            border-radius: var(--border-radius-sm);
            padding: 10px; /* Reducido */
            margin-top: 15px; /* Reducido */
            margin-bottom: 15px; /* Reducido */
            font-weight: 600;
        }

        .reservation-list-container {
            display: flex;
            flex-direction: column;
            gap: 20px; /* Reducido */
        }

        #reservationSearch,
        #archiveSearch {
            width: calc(100% - 16px); /* Ajustado para padding reducido */
            padding: 8px 8px; /* Reducido */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 0.9em; /* Reducido */
            transition: all var(--transition-speed) ease;
            box-shadow: var(--shadow-light);
            background-color: var(--background-color);
            color: var(--text-color);
        }
        #reservationSearch:focus,
        #archiveSearch:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.1);
            background-color: var(--white-color);
        }

        .reservation-list {
            display: flex;
            flex-direction: column;
            gap: 12px; /* Reducido */
            padding: 0;
            margin: 0;
            list-style: none;
            max-height: 500px; /* Reducido */
            overflow-y: auto;
            padding-right: 8px; /* Reducido */
        }

        .reservation-item {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--primary-color); /* Reducido */
            border-radius: var(--border-radius-sm);
            padding: 12px 15px; /* Reducido */
            font-size: 0.85em; /* Reducido */
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: var(--shadow-light);
            transition: transform 0.2s ease, box-shadow 0.2s ease; /* Transición más rápida */
        }
        .reservation-item:hover {
            transform: translateY(-2px); /* Reducido */
            box-shadow: var(--shadow-medium);
        }

        .reservation-item.archived {
            border-left-color: var(--secondary-color);
        }

        .reservation-item span {
            padding: 0 6px; /* Reducido */
            white-space: nowrap;
        }

        .reservation-item .room-name {
            font-weight: 700;
            color: var(--primary-color);
            flex-basis: 35%;
            min-width: 160px; /* Reducido */
            font-size: 0.95em; /* Reducido */
        }

        .reservation-item .restaurant-time {
            color: var(--text-color);
            flex-basis: 30%;
            min-width: 140px; /* Reducido */
            font-weight: 500;
        }
        .reservation-item .pax-info {
            font-weight: 700;
            color: var(--white-color);
            background-color: var(--accent-color);
            padding: 5px 10px; /* Reducido */
            border-radius: 18px; /* Reducido */
            margin-left: auto;
            min-width: 60px; /* Reducido */
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08); /* Reducido */
        }

        .reservation-item .archive-date {
            font-size: 0.7em; /* Reducido */
            color: var(--light-text-color);
            margin-top: 8px; /* Reducido */
            flex-basis: 100%;
            text-align: right;
            border-top: 1px dashed rgba(0,0,0,0.08); /* Reducido */
            padding-top: 6px; /* Reducido */
        }
        .archive-date-section h4 {
            font-family: var(--font-family-heading);
            color: var(--primary-color);
            font-size: 1.4em; /* Reducido */
            font-weight: 600;
            margin-top: 25px; /* Reducido */
            margin-bottom: 12px; /* Reducido */
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px; /* Reducido */
            letter-spacing: -0.02em;
        }
        .archive-date-section:first-child h4 {
            margin-top: 0;
        }


        .no-reservations {
            text-align: center;
            color: var(--light-text-color);
            font-style: italic;
            padding: 25px; /* Reducido */
            border: 1px dashed var(--border-color);
            border-radius: var(--border-radius-md);
            margin-top: 15px; /* Reducido */
            font-size: 1em; /* Reducido */
            background-color: var(--background-color);
        }

        /* Modal / Popup Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Menos opaco */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-background);
            padding: 20px; /* Reducido aún más */
            border-radius: var(--border-radius-md);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15); /* Sombra más pequeña */
            width: 90%;
            max-width: 450px; /* Reducido aún más */
            text-align: center;
            transform: translateY(-30px); /* Reducido */
            transition: transform var(--transition-speed) cubic-bezier(0.2, 0.8, 0.2, 1);
            box-sizing: border-box;
            margin: 10px auto; /* Reducido */
            position: relative;
            animation: fadeInScaleUp 0.3s forwards; /* Más rápido */
            max-height: 75vh; /* Reducido */
            display: flex;
            flex-direction: column;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        @keyframes fadeInScaleUp {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.97); /* Reducido */
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-close-btn {
            position: absolute;
            top: 10px; /* Reducido */
            right: 10px; /* Reducido */
            background: none;
            border: none;
            font-size: 1.6em; /* Reducido */
            cursor: pointer;
            color: var(--light-text-color);
            transition: color 0.2s ease, transform 0.2s ease;
            line-height: 1;
            padding: 0;
        }

        .modal-close-btn:hover {
            color: var(--text-color);
            transform: rotate(90deg); /* Menos rotación */
        }

        #summaryModal .modal-content,
        #archiveModal .modal-content {
            max-width: 600px; /* Reducido */
            text-align: left;
        }
        #summaryModal .modal-content h3,
        #archiveModal .modal-content h3 {
            font-family: var(--font-family-heading);
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px; /* Reducido */
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px; /* Reducido */
            text-align: center;
            font-size: 1.6em; /* Reducido */
            font-weight: 700;
        }

        #summaryContent,
        #archiveListContent {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px; /* Reducido */
            margin-bottom: 15px; /* Reducido */
        }

        .summary-restaurant {
            margin-bottom: 18px; /* Reducido */
            padding-bottom: 10px; /* Reducido */
            border-bottom: 1px solid var(--border-color);
        }

        .summary-restaurant:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .summary-restaurant h4 {
            font-family: var(--font-family-heading);
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 6px; /* Reducido */
            font-size: 1.2em; /* Reducido */
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding-bottom: 5px; /* Reducido */
            border-bottom: 1px dotted var(--border-color);
            font-weight: 600;
        }

        .summary-restaurant h4 span {
            font-size: 0.6em; /* Reducido */
            color: var(--light-text-color);
            font-weight: normal;
        }

        .summary-time-group {
            margin-left: 10px; /* Reducido */
            margin-bottom: 10px; /* Reducido */
            padding: 6px; /* Reducido */
            border-left: 2px solid var(--secondary-color); /* Reducido */
            background-color: var(--background-color);
            border-radius: var(--border-radius-sm);
            box-shadow: 0 1px 4px rgba(0,0,0,0.02); /* Reducido */
        }
        .summary-time-group:last-child {
            margin-bottom: 0;
        }

        .summary-time {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px; /* Reducido */
            padding-bottom: 5px; /* Reducido */
            border-bottom: 1px dashed rgba(0,0,0,0.05); /* Reducido */
            font-size: 0.9em; /* Reducido */
            display: flex;
            justify-content: space-between;
        }
        .summary-time span {
            color: var(--primary-color);
            font-weight: 700;
        }

        .summary-reservation-detail {
            margin-left: 10px; /* Reducido */
            font-size: 0.8em; /* Reducido */
            color: var(--light-text-color);
            margin-bottom: 1px; /* Reducido */
            line-height: 1.3; /* Reducido */
        }
        .summary-reservation-detail strong {
            color: var(--primary-color);
        }
        .summary-reservation-detail:last-child {
            margin-bottom: 0;
        }

        .summary-overall-pax {
            text-align: right;
            margin-top: 12px; /* Reducido */
            font-size: 1em; /* Reducido */
            font-weight: 700;
            color: var(--primary-color);
            padding-top: 10px; /* Reducido */
            border-top: 1px solid var(--border-color);
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 12px; /* Reducido */
            margin-top: auto;
            padding-top: 12px; /* Reducido */
        }


        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                padding: 20px;
                gap: 20px;
            }
            .header h1 {
                font-size: 1.8em;
            }
            .btn {
                padding: 7px 15px;
                font-size: 0.8em;
            }
            .main-content {
                grid-template-columns: 1fr;
            }
            section {
                padding: 18px;
            }
            section h2 {
                font-size: 1.3em;
            }
            .form-grid {
                gap: 10px;
            }
            input[type="text"], input[type="number"], select, textarea, #reservationSearch, #archiveSearch {
                padding: 7px 5px;
            }
            .reservation-item {
                padding: 9px 10px;
                font-size: 0.75em;
            }
            .modal-content {
                padding: 20px;
            }
            .modal-close-btn {
                font-size: 1.4em;
                top: 8px;
                right: 8px;
            }
            #summaryModal .modal-content, #archiveModal .modal-content {
                max-width: 85%;
            }
            .summary-restaurant h4 {
                font-size: 1.1em;
            }
            .summary-time-group {
                margin-left: 6px;
                padding: 5px;
            }
            .summary-reservation-detail {
                margin-left: 6px;
                font-size: 0.7em;
            }
            .summary-overall-pax {
                font-size: 0.9em;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            .container {
                padding: 12px;
                gap: 15px;
            }
            .header {
                flex-direction: column;
                text-align: center;
                align-items: center;
            }
            .header h1 {
                font-size: 1.4em;
            }
            .header .buttons-group {
                flex-direction: column;
                width: 100%;
            }
            .header .buttons-group .btn {
                width: 100%;
            }
            .form-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .form-group-full {
                grid-column: span 1;
            }
            .reservation-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
                padding: 7px 8px;
            }
            .reservation-item span {
                white-space: normal;
            }
            .reservation-item .room-name,
            .reservation-item .restaurant-time,
            .reservation-item .pax-info {
                flex-basis: 100%;
                min-width: unset;
                text-align: left;
            }
            .reservation-item .pax-info {
                margin-left: 0;
            }
            .reservation-item .archive-date {
                text-align: left;
            }
            .modal-content {
                padding: 18px;
            }
            .modal-close-btn {
                font-size: 1.3em;
                top: 6px;
                right: 6px;
            }
            .summary-restaurant h4 {
                font-size: 1em;
            }
            .summary-time-group {
                margin-left: 5px;
                padding: 4px;
            }
            .summary-reservation-detail {
                margin-left: 5px;
                font-size: 0.65em;
            }
            .summary-overall-pax {
                font-size: 0.8em;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 6px;
            }
            .header h1 {
                font-size: 1.2em;
            }
            section h2 {
                font-size: 1.2em;
            }
            .btn {
                padding: 6px 12px;
                font-size: 0.75em;
            }
            input[type="text"], input[type="number"], select, textarea, #reservationSearch, #archiveSearch {
                padding: 5px 5px;
            }
            .modal-content {
                padding: 12px;
            }
            .modal-close-btn {
                font-size: 1.2em;
                top: 5px;
                right: 5px;
            }
            .summary-restaurant h4 {
                font-size: 0.9em;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Gestor de Reservas Diarias</h1>
            <div class="buttons-group">
                <button id="addReservationBtn" class="btn btn-primary">
                    Agregar Nueva Reserva
                </button>
                <button id="viewSummaryBtn" class="btn btn-secondary">
                    Ver Resumen de Reservas
                </button>
                <button id="viewArchiveBtn" class="btn btn-secondary">
                    Ver Archivo de Reservas
                </button>
            </div>
        </header>

        <main class="main-content">
            <section class="reservation-form-section">
                <h2>Detalles de la Reserva</h2>
                <form id="reservationForm" class="form-grid">
                    <div class="form-group">
                        <label for="room">Número de Habitación:</label>
                        <input type="number" id="room" placeholder="Ej. 1234" min="1000" max="9999" required>
                    </div>
                    <div class="form-group">
                        <label for="guest">Nombre del Huesped:</label>
                        <input type="text" id="guest" placeholder="Ej. Juan Pérez" required>
                    </div>
                    <div class="form-group">
                        <label for="place">Restaurante:</label>
                        <select id="place" required>
                            <option value="">Seleccione un restaurante</option>
                            <option value="El Patio">El Patio</option>
                            <option value="Bluewater">Bluewater</option>
                            <option value="Bordeaux">Bordeaux</option>
                            <option value="Himitsu">Himitsu</option>
                            <option value="Hibachi">Hibachi</option>
                            <option value="El Olio">El Olio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="time">Hora de Reserva:</label>
                        <select id="time" required>
                            <option value="">Seleccione un restaurante primero</option>
                        </select>
                        <div id="availabilityInfo" class="availability-info"></div>
                    </div>
                    <div class="form-group">
                        <label for="pax">Cantidad de Personas:</label>
                        <input type="number" id="pax" min="1" value="1" required>
                    </div>
                    <div class="form-group form-group-full">
                        <label for="comment">Comentario:</label>
                        <textarea id="comment" rows="3" placeholder="Notas especiales, alergias, etc."></textarea>
                    </div>
                    <div id="operatingHoursMessage" class="operating-hours-message" style="display:none;">
                        Las reservas solo se pueden registrar entre las 7:00 AM y las 4:30 PM.
                    </div>
                    <button type="submit" class="btn btn-submit" id="submitReservationBtn">Registrar Reserva</button>
                </form>
            </section>

            <section class="reservation-list-section">
                <h2>Reservas del Día</h2>
                <div class="reservation-list-container">
                    <input type="text" id="reservationSearch" placeholder="Buscar por habitación o guest...">
                    <div id="reservationList" class="reservation-list">
                        <p class="no-reservations" id="noReservationsMessage">No hay reservas programadas para hoy.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="validationModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal="validationModal">&times;</button>
            <h3>Validar Solicitante</h3>
            <p>Por favor, ingrese el nombre de la persona que realiza la reserva.</p>
            <input type="text" id="validatorNameInput" placeholder="Nombre del Solicitante" required>
            <div class="modal-actions">
                <button id="confirmValidationBtn" class="btn btn-primary">Confirmar</button>
                <button id="cancelValidationBtn" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="summaryModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal="summaryModal">&times;</button>
            <h3 id="summaryTitle">Resumen de Reservas</h3>
            <div id="summaryContent" class="summary-content">
                <p>Cargando resumen...</p>
            </div>
            <p id="overallPaxTotal" class="summary-overall-pax"></p>
            <div class="modal-actions">
                <button id="closeSummaryBtn" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="archiveModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal="archiveModal">&times;</button>
            <h3 id="archiveTitle">Archivo de Reservas Históricas</h3>
            <input type="text" id="archiveSearch" placeholder="Buscar en el archivo por habitación, comensal o fecha...">
            <div id="archiveListContent" class="reservation-list">
                <p class="no-reservations" id="noArchivedReservationsMessage">No hay reservas archivadas.</p>
            </div>
            <div class="modal-actions">
                <button id="closeArchiveBtn" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar las funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, get, child, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyALR-b68phh_u92V3rw9B9Ei7FcexU2xc8",
            authDomain: "proyectos17-98695.firebaseapp.com",
            projectId: "proyectos17-98695",
            storageBucket: "proyectos17-98695.firebasestorage.app",
            messagingSenderId: "951673973410",
            appId: "1:951673973410:web:4bc355e825cf86308645fb",
            measurementId: "G-6YK06W16FZ"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app); // Obtener referencia a la Realtime Database

        document.addEventListener('DOMContentLoaded', () => {
            const addReservationBtn = document.getElementById('addReservationBtn');
            const viewSummaryBtn = document.getElementById('viewSummaryBtn');
            const viewArchiveBtn = document.getElementById('viewArchiveBtn');
            const reservationForm = document.getElementById('reservationForm');
            const reservationListDiv = document.getElementById('reservationList');
            const noReservationsMessage = document.getElementById('noReservationsMessage');
            const validationModal = document.getElementById('validationModal');
            const validatorNameInput = document.getElementById('validatorNameInput');
            const confirmValidationBtn = document.getElementById('confirmValidationBtn');
            const cancelValidationBtn = document.getElementById('cancelValidationBtn');

            const summaryModal = document.getElementById('summaryModal');
            const summaryTitle = document.getElementById('summaryTitle');
            const summaryContent = document.getElementById('summaryContent');
            const overallPaxTotal = document.getElementById('overallPaxTotal');
            const closeSummaryBtn = document.getElementById('closeSummaryBtn');

            const archiveModal = document.getElementById('archiveModal');
            const archiveTitle = document.getElementById('archiveTitle');
            const archiveSearchInput = document.getElementById('archiveSearch');
            const archiveListContent = document.getElementById('archiveListContent');
            const noArchivedReservationsMessage = document.getElementById('noArchivedReservationsMessage');
            const closeArchiveBtn = document.getElementById('closeArchiveBtn');

            const modalCloseButtons = document.querySelectorAll('.modal-close-btn');

            const roomInput = document.getElementById('room');
            const placeSelect = document.getElementById('place');
            const timeSelect = document.getElementById('time');
            const paxInput = document.getElementById('pax');
            const availabilityInfo = document.getElementById('availabilityInfo');

            const reservationSearchInput = document.getElementById('reservationSearch');
            const submitReservationBtn = document.getElementById('submitReservationBtn');
            const operatingHoursMessage = document.getElementById('operatingHoursMessage');

            let reservations = []; // Reservas del día actual, ahora se sincronizarán con Firebase
            let archivedReservations = []; // Reservas de días anteriores, también desde Firebase
            let currentReservationData = null;
            let lastAccessDate = localStorage.getItem('lastAccessDate'); // Todavía usado para control de fecha de acceso

            const restaurantTimes = {
                "El Patio": ["18:00", "21:00"],
                "Bluewater": ["18:00", "21:00"],
                "Bordeaux": ["18:00", "21:00"],
                "Himitsu": ["18:00", "21:00"],
                "Hibachi": ["17:30", "18:45", "20:00", "21:15"],
                "El Olio": ["18:30", "21:00"]
            };

            const restaurantPaxLimits = {
                "El Patio": 8,
                "Bluewater": 8,
                "Bordeaux": 6,
                "Himitsu": 8,
                "Hibachi": 10,
                "El Olio": 8
            };

            // --- Funciones de Utilidad de Fecha y Hora ---
            function getTodayDateString() {
                const today = new Date();
                return today.toISOString().slice(0, 10); // Formato YYYY-MM-DD
            }

            function getFormattedDate(dateString) {
                if (!dateString) return 'Fecha desconocida';
                const date = new Date(dateString + 'T12:00:00'); // Añadir T12:00:00 para evitar problemas de zona horaria
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('es-ES', options);
            }

            function convertTo12HourFormat(time24h) {
                const [hours, minutes] = time24h.split(':');
                const hour = parseInt(hours, 10);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour % 12 || 12;
                return `${displayHour}:${minutes} ${ampm}`;
            }

            // Nueva función para verificar el horario de operación
            function checkOperatingHours() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                const currentTimeInMinutes = currentHour * 60 + currentMinute;

                const startHourInMinutes = 7 * 60; // 7:00 AM
                const endHourInMinutes = 16 * 60 + 30; // 4:30 PM (16:30 PM)

                const isInOperatingHours = currentTimeInMinutes >= startHourInMinutes && currentTimeInMinutes <= endHourInMinutes;

                submitReservationBtn.disabled = !isInOperatingHours;
                if (!isInOperatingHours) {
                    operatingHoursMessage.style.display = 'block';
                } else {
                    operatingHoursMessage.style.display = 'none';
                }
                return isInOperatingHours;
            }

            // --- Lógica de Carga y Archivamiento con Firebase ---
            async function loadAndArchiveReservations() {
                const today = getTodayDateString();
                const dailyReservationsRef = ref(database, `dailyReservations/${today}`);
                const allArchivedReservationsRef = ref(database, 'archivedReservations');

                try {
                    // Cargar reservas archivadas (todas)
                    const archiveSnapshot = await get(allArchivedReservationsRef);
                    if (archiveSnapshot.exists()) {
                        archivedReservaciones = [];
                        archiveSnapshot.forEach(dateNode => {
                            dateNode.forEach(resNode => {
                                archivedReservations.push({ id: resNode.key, ...resNode.val() });
                            });
                        });
                    } else {
                        archivedReservations = [];
                    }

                    if (lastAccessDate && lastAccessDate !== today) {
                        // Es un nuevo día, archivar las reservas del día anterior
                        const previousDayReservationsRef = ref(database, `dailyReservations/${lastAccessDate}`);
                        const previousDaySnapshot = await get(previousDayReservationsRef);

                        if (previousDaySnapshot.exists()) {
                            const previousDayData = previousDaySnapshot.val();
                            const updates = {};
                            for (const key in previousDayData) {
                                const res = previousDayData[key];
                                res.archiveDate = lastAccessDate; // Asegurarse de que tengan la fecha de archivo
                                // Mover a la ruta de archivados bajo su fecha original
                                updates[`archivedReservations/${lastAccessDate}/${key}`] = res;
                            }
                            // Eliminar las reservas del día anterior después de moverlas
                            updates[`dailyReservations/${lastAccessDate}`] = null;

                            await set(ref(database), updates); // Realizar la operación de actualización en lote
                            console.log(`Reservas del ${lastAccessDate} archivadas y borradas.`);
                        }
                        // Después de archivar, las reservas del día actual se reinician (se cargan de Firebase, que estará vacío para el nuevo día)
                        reservations = [];
                        // La carga del día actual se manejará con onValue para actualizaciones en tiempo real
                    }

                    // Actualizar la fecha de último acceso en localStorage
                    localStorage.setItem('lastAccessDate', today);
                    lastAccessDate = today;

                    // Escuchar cambios en las reservas del día actual en tiempo real
                    onValue(dailyReservationsRef, (snapshot) => {
                        const data = snapshot.val();
                        reservations = [];
                        if (data) {
                            for (const key in data) {
                                reservations.push({ id: key, ...data[key] });
                            }
                        }
                        renderReservations(); // Volver a renderizar cada vez que cambian las reservas
                        updateAvailabilityInfo(); // Actualizar disponibilidad también
                    });

                } catch (error) {
                    console.error("Error al cargar o archivar reservas:", error);
                    alert("Hubo un error al cargar los datos de las reservas. Por favor, intente de nuevo.");
                }

                checkOperatingHours(); // Verificar horario y deshabilitar/habilitar botón
            }


            // Llamar a la función de carga y archivo al inicio
            loadAndArchiveReservations();

            // Evento para mostrar el formulario de agregar reserva
            addReservationBtn.addEventListener('click', () => {
                reservationForm.reset();
                placeSelect.value = "";
                updateTimeOptions(placeSelect.value);
                timeSelect.disabled = true;
                availabilityInfo.textContent = '';
                availabilityInfo.className = 'availability-info';
                roomInput.focus();
                reservationForm.scrollIntoView({ behavior: 'smooth' });
                reservationSearchInput.value = '';
                filterReservations();
                checkOperatingHours();
            });

            // Evento para abrir el popup de resumen
            viewSummaryBtn.addEventListener('click', () => {
                generateReservationsSummary();
                showSummaryModal();
            });

            // Nuevo: Evento para abrir el popup de archivo
            viewArchiveBtn.addEventListener('click', async () => { // Hacer async para la carga de archivo
                archiveSearchInput.value = ''; // Limpiar buscador del archivo

                // Recargar todas las reservas archivadas para asegurar que estén al día
                const allArchivedReservationsRef = ref(database, 'archivedReservations');
                try {
                    const archiveSnapshot = await get(allArchivedReservationsRef);
                    archivedReservations = [];
                    if (archiveSnapshot.exists()) {
                        archiveSnapshot.forEach(dateNode => {
                            dateNode.forEach(resNode => {
                                archivedReservations.push({ id: resNode.key, ...resNode.val() });
                            });
                        });
                    }
                    renderArchivedReservations(); // Renderizar todas las archivadas al abrir
                    showArchiveModal();
                } catch (error) {
                    console.error("Error al cargar el archivo de reservas:", error);
                    alert("No se pudo cargar el archivo de reservas. Por favor, intente de nuevo.");
                }
            });

            // Evento para cerrar el popup de resumen
            closeSummaryBtn.addEventListener('click', () => {
                hideSummaryModal();
            });

            // Nuevo: Evento para cerrar el popup de archivo
            closeArchiveBtn.addEventListener('click', () => {
                hideArchiveModal();
            });

            // Eventos para cerrar modales al hacer clic en el botón 'X'
            modalCloseButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const modalId = e.target.dataset.modal;
                    if (modalId === 'validationModal') {
                        hideValidationModal();
                        currentReservationData = null;
                    } else if (modalId === 'summaryModal') {
                        hideSummaryModal();
                    } else if (modalId === 'archiveModal') {
                        hideArchiveModal();
                    }
                });
            });

            // Eventos para cerrar modales al hacer clic fuera
            validationModal.addEventListener('click', (e) => {
                if (e.target === validationModal) {
                    hideValidationModal();
                    currentReservationData = null;
                }
            });

            summaryModal.addEventListener('click', (e) => {
                if (e.target === summaryModal) {
                    hideSummaryModal();
                }
            });

            archiveModal.addEventListener('click', (e) => {
                if (e.target === archiveModal) {
                    hideArchiveModal();
                }
            });

            // Eventos para actualizar el contador de disponibilidad
            placeSelect.addEventListener('change', () => {
                const selectedRestaurant = placeSelect.value;
                updateTimeOptions(selectedRestaurant);
                updateAvailabilityInfo();
            });

            timeSelect.addEventListener('change', () => {
                updateAvailabilityInfo();
            });

            paxInput.addEventListener('input', () => {
                updateAvailabilityInfo();
            });

            // Evento para el buscador de reservas del día
            reservationSearchInput.addEventListener('input', () => {
                filterReservations();
            });

            // Nuevo: Evento para el buscador de reservas archivadas
            archiveSearchInput.addEventListener('input', () => {
                filterArchivedReservations();
            });

            // Función para actualizar las opciones de hora según el restaurante seleccionado
            function updateTimeOptions(restaurant) {
                timeSelect.innerHTML = '';
                if (restaurant && restaurantTimes[restaurant]) {
                    timeSelect.disabled = false;
                    const times = restaurantTimes[restaurant];
                    const defaultTimeOption = document.createElement('option');
                    defaultTimeOption.value = "";
                    defaultTimeOption.textContent = "Seleccione una hora";
                    timeSelect.appendChild(defaultTimeOption);

                    times.forEach(time24h => {
                        const option = document.createElement('option');
                        option.value = time24h;
                        option.textContent = convertTo12HourFormat(time24h);
                        timeSelect.appendChild(option);
                    });
                } else {
                    timeSelect.disabled = true;
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.textContent = "Seleccione un restaurante primero";
                    timeSelect.appendChild(defaultOption);
                }
            }

            // Función para calcular y mostrar la disponibilidad
            function updateAvailabilityInfo() {
                const selectedRestaurant = placeSelect.value;
                const selectedTime = timeSelect.value;
                const requestedPax = parseInt(paxInput.value, 10);

                if (!selectedRestaurant || !selectedTime) {
                    availabilityInfo.textContent = 'Seleccione restaurante y hora para ver disponibilidad.';
                    availabilityInfo.className = 'availability-info';
                    timeSelect.setCustomValidity('');
                    return;
                }

                const maxPax = restaurantPaxLimits[selectedRestaurant];
                if (maxPax === undefined) {
                    availabilityInfo.textContent = 'Límite de PAX no definido para este restaurante.';
                    availabilityInfo.className = 'availability-info';
                    return;
                }

                const occupiedPax = reservations
                    .filter(res => res.place === selectedRestaurant && res.time === selectedTime)
                    .reduce((sum, res) => sum + res.pax, 0);

                const remainingPax = maxPax - occupiedPax;

                availabilityInfo.textContent = `Espacios disponibles: ${remainingPax} de ${maxPax}`;

                availabilityInfo.className = 'availability-info';
                if (remainingPax > 0) {
                    if (requestedPax > remainingPax) {
                        availabilityInfo.textContent += ` (Solo quedan ${remainingPax})`;
                        availabilityInfo.classList.add('limited');
                        timeSelect.setCustomValidity('');
                    } else {
                        availabilityInfo.classList.add('available');
                        timeSelect.setCustomValidity('');
                    }
                } else {
                    availabilityInfo.textContent = '¡No hay espacios disponibles para esta hora!';
                    availabilityInfo.classList.add('full');
                    timeSelect.setCustomValidity('No hay espacios disponibles en este horario.');
                    timeSelect.reportValidity();
                }
            }


            // Evento para manejar el envío del formulario
            reservationForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!checkOperatingHours()) {
                    alert('No se pueden registrar reservas fuera del horario de operación (7:00 AM - 4:30 PM).');
                    return;
                }

                const room = document.getElementById('room').value;
                const guest = document.getElementById('guest').value;
                const place = document.getElementById('place').value;
                const time = document.getElementById('time').value;
                const pax = parseInt(document.getElementById('pax').value, 10);
                const comment = document.getElementById('comment').value;

                if (room.length !== 4 || isNaN(room) || parseInt(room, 10) < 1000 || parseInt(room, 10) > 9999) {
                    alert('Por favor, ingrese un número de habitación válido de 4 dígitos (ej. 1000-9999).');
                    roomInput.focus();
                    return;
                }

                if (!time) {
                    alert('Por favor, seleccione una hora de reserva válida para el restaurante elegido.');
                    return;
                }

                const maxPax = restaurantPaxLimits[place];
                // Note: The actual check for remainingPax will happen inside the transaction
                // This client-side check is just for immediate feedback before the transaction attempt.
                const currentOccupiedPaxForClientCheck = reservations
                    .filter(res => res.place === place && res.time === time)
                    .reduce((sum, res) => sum + res.pax, 0);

                if (pax > (maxPax - currentOccupiedPaxForClientCheck)) {
                    alert(`Lo sentimos, solo quedan ${maxPax - currentOccupiedPaxForClientCheck} espacios disponibles para ${place} a las ${convertTo12HourFormat(time)}. Por favor, ajuste la cantidad de personas.`);
                    paxInput.focus();
                    return;
                }

                currentReservationData = {
                    room,
                    guest,
                    place,
                    time,
                    pax,
                    comment,
                    timestamp: new Date().getTime(),
                    date: getTodayDateString()
                };

                showValidationModal();
            });

            // Evento para confirmar la validación del nombre
            confirmValidationBtn.addEventListener('click', async () => {
                const validatorName = validatorNameInput.value.trim();
                if (validatorName) {
                    currentReservationData.validator = validatorName;
                    await addReservation(currentReservationData); // Esperar la operación de Firebase
                    hideValidationModal();
                    reservationForm.reset();
                    placeSelect.value = "";
                    updateTimeOptions(placeSelect.value);
                    timeSelect.disabled = true;
                    availabilityInfo.textContent = '';
                    availabilityInfo.className = 'availability-info';
                    currentReservationData = null;
                    checkOperatingHours();
                } else {
                    alert('Por favor, ingrese el nombre de quien solicita la reserva.');
                }
            });

            // Evento para cancelar la validación
            cancelValidationBtn.addEventListener('click', () => {
                hideValidationModal();
                currentReservationData = null;
            });

            // Funciones para mostrar/ocultar modales
            function showValidationModal() {
                validationModal.classList.add('active');
                validatorNameInput.value = '';
                validatorNameInput.focus();
            }

            function hideValidationModal() {
                validationModal.classList.remove('active');
            }

            function showSummaryModal() {
                summaryModal.classList.add('active');
            }

            function hideSummaryModal() {
                summaryModal.classList.remove('active');
            }

            function showArchiveModal() {
                archiveModal.classList.add('active');
            }

            function hideArchiveModal() {
                archiveModal.classList.remove('active');
            }

            // Función para añadir reserva a Firebase usando transacción
            async function addReservation(data) {
                const today = getTodayDateString();
                const dailyReservationsRef = ref(database, `dailyReservations/${today}`);
                const selectedRestaurant = data.place;
                const selectedTime = data.time;
                const requestedPax = data.pax;
                const maxPax = restaurantPaxLimits[selectedRestaurant];
                const roomNumber = data.room; // Obtener el número de habitación de los datos de la reserva

                try {
                    const result = await runTransaction(dailyReservationsRef, (currentData) => {
                        const existingReservations = currentData || {};
                        let occupiedPax = 0;

                        // Verificar si ya existe una reserva para esta habitación hoy
                        for (const key in existingReservations) {
                            if (existingReservations.hasOwnProperty(key)) {
                                const res = existingReservations[key];
                                if (res.room === roomNumber) {
                                    // Si ya existe una reserva para esta habitación, abortar la transacción
                                    console.log(`Transacción abortada: La habitación ${roomNumber} ya tiene una reserva para hoy.`);
                                    return; // Abortar la transacción
                                }
                                if (res.place === selectedRestaurant && res.time === selectedTime) {
                                    occupiedPax += res.pax;
                                }
                            }
                        }

                        if (occupiedPax + requestedPax > maxPax) {
                            console.log("Transacción abortada: No hay suficiente espacio.");
                            return; // Abortar la transacción
                        } else {
                            const newKey = push(dailyReservationsRef).key;
                            existingReservations[newKey] = data;
                            console.log("Transacción exitosa: Reserva añadida.");
                            return existingReservations; // Retornar los datos actualizados para confirmar la transacción
                        }
                    });

                    if (result.committed) {
                        alert('¡Reserva realizada con éxito!');
                    } else {
                        // Si la transacción no se comprometió, podría ser por espacio o por duplicado de habitación
                        // El mensaje de alerta ya se maneja dentro de la transacción si es por habitación duplicada
                        // Si es por PAX, el mensaje ya está definido.
                        // Modificación: Mostrar mensaje específico si la habitación ya está reservada
                        const isRoomAlreadyReserved = reservations.some(res => res.room === roomNumber);
                        if (isRoomAlreadyReserved) {
                            alert(`Error: La habitación ${roomNumber} ya tiene una reserva para hoy.`);
                        } else {
                            alert(`No se pudo registrar la reserva. No hay suficientes espacios disponibles para ${selectedRestaurant} a las ${convertTo12HourFormat(selectedTime)}. Por favor, intente con menos personas o en otro horario.`);
                        }
                    }
                } catch (error) {
                    console.error("Error en la transacción de reserva:", error);
                    alert("Hubo un error al procesar su reserva. Por favor, intente de nuevo.");
                }
            }


            // Función principal para renderizar reservas (ahora usa los datos de `reservations` que se actualizan desde Firebase)
            function renderReservations(filteredReservations = reservations) {
                filteredReservations.sort((a, b) => {
                    const restaurantComparison = a.place.localeCompare(b.place);
                    if (restaurantComparison !== 0) return restaurantComparison;
                    const timeComparison = a.time.localeCompare(b.time);
                    if (timeComparison !== 0) return timeComparison;
                    return parseInt(a.room) - parseInt(b.room);
                });

                reservationListDiv.innerHTML = '';

                if (filteredReservations.length === 0) {
                    noReservationsMessage.textContent = reservations.length === 0 ?
                                                        'No hay reservas programadas para hoy.' :
                                                        'No se encontraron reservas con los criterios de búsqueda.';
                    noReservationsMessage.style.display = 'block';
                } else {
                    noReservationsMessage.style.display = 'none';
                    filteredReservations.forEach((res) => {
                        const reservationItem = document.createElement('div');
                        reservationItem.classList.add('reservation-item');

                        const time12Hrs = convertTo12HourFormat(res.time);

                        reservationItem.innerHTML = `
                            <span class="room-name">${res.room} - ${res.guest}</span>
                            <span class="restaurant-time">${res.place} - ${time12Hrs}</span>
                            <span class="pax-info">${res.pax} PAX</span>
                        `;
                        reservationListDiv.appendChild(reservationItem);
                    });
                }
            }

            // Función para renderizar reservas archivadas (ahora usa los datos de `archivedReservations` que se actualizan desde Firebase)
            function renderArchivedReservations(filteredArchived = archivedReservations) {
                filteredArchived.sort((a, b) => {
                    const dateComparison = new Date(b.archiveDate).getTime() - new Date(a.archiveDate).getTime();
                    if (dateComparison !== 0) return dateComparison;
                    const restaurantComparison = a.place.localeCompare(b.place);
                    if (restaurantComparison !== 0) return restaurantComparison;
                    return a.time.localeCompare(b.time);
                });

                archiveListContent.innerHTML = '';

                if (filteredArchived.length === 0) {
                    noArchivedReservationsMessage.textContent = archivedReservations.length === 0 ?
                                                                'No hay reservas archivadas.' :
                                                                'No se encontraron reservas archivadas con los criterios de búsqueda.';
                    noArchivedReservationsMessage.style.display = 'block';
                } else {
                    noArchivedReservationsMessage.style.display = 'none';
                    // Group reservations by date for the archive view
                    const groupedByDate = new Map();
                    filteredArchived.forEach(res => {
                        const dateKey = res.archiveDate;
                        if (!groupedByDate.has(dateKey)) {
                            groupedByDate.set(dateKey, []);
                        }
                        groupedByDate.get(dateKey).push(res);
                    });

                    // Sort dates (most recent first)
                    const sortedDates = Array.from(groupedByDate.keys()).sort((a, b) => {
                        return new Date(b).getTime() - new Date(a).getTime();
                    });

                    sortedDates.forEach(dateKey => {
                        const dateSection = document.createElement('div');
                        dateSection.classList.add('archive-date-section');

                        const dateHeader = document.createElement('h4');
                        dateHeader.textContent = getFormattedDate(dateKey);
                        dateSection.appendChild(dateHeader);

                        const reservationsForDate = groupedByDate.get(dateKey);
                        reservationsForDate.sort((a, b) => {
                            const restaurantComparison = a.place.localeCompare(b.place);
                            if (restaurantComparison !== 0) return restaurantComparison;
                            return a.time.localeCompare(b.time);
                        });

                        reservationsForDate.forEach(res => {
                            const reservationItem = document.createElement('div');
                            reservationItem.classList.add('reservation-item', 'archived');

                            const time12Hrs = convertTo12HourFormat(res.time);

                            reservationItem.innerHTML = `
                                <span class="room-name">${res.room} - ${res.guest}</span>
                                <span class="restaurant-time">${res.place} - ${time12Hrs}</span>
                                <span class="pax-info">${res.pax} PAX</span>
                                ${res.comment ? `<span>${res.comment}</span>` : ''}
                                ${res.validator ? `<span class="archive-validator">Por: ${res.validator})</span>` : ''}
                            `;
                            dateSection.appendChild(reservationItem);
                        });
                        archiveListContent.appendChild(dateSection);
                    });
                }
            }

            // Función para filtrar reservas del día
            function filterReservations() {
                const searchTerm = reservationSearchInput.value.toLowerCase().trim();

                if (!searchTerm) {
                    renderReservations(reservations);
                    return;
                }

                const filtered = reservations.filter(res => {
                    const roomMatches = String(res.room).includes(searchTerm);
                    const guestMatches = res.guest.toLowerCase().includes(searchTerm);
                    const restaurantMatches = res.place.toLowerCase().includes(searchTerm);
                    const timeMatches = convertTo12HourFormat(res.time).toLowerCase().includes(searchTerm);
                    return roomMatches || guestMatches || restaurantMatches || timeMatches;
                });

                renderReservations(filtered);
            }

            // Nueva función para filtrar reservas archivadas
            function filterArchivedReservations() {
                const searchTerm = archiveSearchInput.value.toLowerCase().trim();

                if (!searchTerm) {
                    renderArchivedReservations(archivedReservations);
                    return;
                }

                const filtered = archivedReservations.filter(res => {
                    const roomMatches = String(res.room).includes(searchTerm);
                    const guestMatches = res.guest.toLowerCase().includes(searchTerm);
                    const restaurantMatches = res.place.toLowerCase().includes(searchTerm);
                    const timeMatches = convertTo12HourFormat(res.time).toLowerCase().includes(searchTerm);
                    const dateMatches = getFormattedDate(res.archiveDate).toLowerCase().includes(searchTerm) || res.archiveDate.includes(searchTerm);
                    return roomMatches || guestMatches || restaurantMatches || timeMatches || dateMatches;
                });

                renderArchivedReservations(filtered);
            }


            // Las funciones saveReservations y saveArchivedReservations ya no son necesarias directamente
            // porque las operaciones de Firebase (push, set) se encargan de la persistencia.
            // Las variables `reservations` y `archivedReservations` se actualizan mediante `onValue` de Firebase.

            function getTodayDateFormatted() {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return today.toLocaleDateString('es-ES', options);
            }

            // Función para generar y mostrar el resumen de reservas en formato de lista/tabla
            function generateReservationsSummary() {
                const groupedReservations = {};
                let totalOverallPax = 0;

                reservations.forEach(res => {
                    const restaurant = res.place;
                    const time = res.time;
                    const pax = res.pax;

                    if (!groupedReservations[restaurant]) {
                        groupedReservations[restaurant] = {
                            totalRestaurantPax: 0,
                            times: {}
                        };
                    }

                    if (!groupedReservations[restaurant].times[time]) {
                        groupedReservations[restaurant].times[time] = {
                            pax: 0,
                            details: []
                        };
                    }

                    groupedReservations[restaurant].totalRestaurantPax += pax;
                    groupedReservations[restaurant].times[time].pax += pax;
                    groupedReservations[restaurant].times[time].details.push(res);
                    totalOverallPax += pax;
                });

                let summaryHtml = '';
                const sortedRestaurants = Object.keys(groupedReservations).sort();

                if (sortedRestaurants.length === 0) {
                    summaryHtml = '<p style="text-align: center; margin-top: 50px;">No hay reservas registradas para hoy.</p>';
                } else {
                    sortedRestaurants.forEach(restaurant => {
                        const restaurantData = groupedReservations[restaurant];
                        summaryHtml += `
                            <div class="summary-restaurant">
                                <h4>${restaurant} <span>(Total PAX: ${restaurantData.totalRestaurantPax})</span></h4>
                        `;

                        const sortedTimes = Object.keys(restaurantData.times).sort();

                        sortedTimes.forEach(time24h => {
                            const timeData = groupedReservations[restaurant].times[time24h];
                            summaryHtml += `
                                <div class="summary-time-group">
                                    <p class="summary-time">${convertTo12HourFormat(time24h)}: <span>${timeData.pax} PAX</span></p>
                            `;
                            timeData.details.sort((a, b) => parseInt(a.room) - parseInt(b.room));

                            timeData.details.forEach(detail => {
                                summaryHtml += `
                                    <p class="summary-reservation-detail">
                                        <strong>${detail.room}</strong> - ${detail.guest} - ${detail.pax} PAX
                                        ${detail.comment ? `<em>(Comentario: ${detail.comment})</em>` : ''}
                                        ${detail.validator ? `<span>(Solicitado por: ${detail.validator})</span>` : ''}
                                    </p>
                                `;
                            });
                            summaryHtml += `</div>`;
                        });
                        summaryHtml += `</div>`;
                    });
                }

                summaryTitle.textContent = `Resumen de Reservas para ${getTodayDateFormatted()}`;
                summaryContent.innerHTML = summaryHtml;
                overallPaxTotal.textContent = `PAX Total del Día: ${totalOverallPax}`;
            }

            // Asegurarse de que el campo de hora esté deshabilitado al inicio y el contador limpio
            timeSelect.disabled = true;
            availabilityInfo.textContent = '';

            // Llamar checkOperatingHours() cada minuto para actualizar el estado del botón
            setInterval(checkOperatingHours, 60 * 1000); // Cada minuto
        });
    </script>
</body>
</html>
