<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservas - Restaurante Xcaret</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF; /* Azul vibrante */
            --secondary-color: #6C757D; /* Gris medio */
            --success-color: #28A745; /* Verde */
            --danger-color: #DC3545; /* Rojo */
            --warning-color: #FFC107; /* Amarillo */
            --info-color: #17A2B8; /* Azul claro */
            --dark-color: #343A40; /* Negro casi */
            --light-color: #F8F9FA; /* Blanco grisáceo */
            --white-color: #FFFFFF; /* Blanco puro */
            --border-color: #DEE2E6; /* Gris de borde */
            --shadow-light: 0 4px 8px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 6px 12px rgba(0, 0, 0, 0.1);
            --border-radius-sm: 0.25rem;
            --border-radius-md: 0.5rem;
            --transition-speed: 0.3s;
            --font-family: 'Poppins', sans-serif;
            --text-color: var(--dark-color);
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--light-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background-color: var(--white-color);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-medium);
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 2.5em;
            font-weight: 700;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            box-shadow: var(--shadow-light);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-success {
            background-color: var(--success-color);
            color: var(--white-color);
        }
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-info {
            background-color: var(--info-color);
            color: var(--white-color);
        }
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        section {
            background-color: var(--white-color);
            padding: 25px 30px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-light);
        }

        section h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="number"],
        input[type="time"],
        select,
        textarea {
            width: calc(100% - 22px); /* Adjust for padding and border */
            padding: 12px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1em;
            color: var(--text-color);
            background-color: var(--light-color);
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            background-color: var(--white-color);
        }

        textarea {
            resize: vertical;
        }

        .reservations-list ul {
            list-style: none;
            padding: 0;
        }

        .reservations-list li {
            background-color: var(--light-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            margin-bottom: 10px;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            font-size: 0.95em;
            box-shadow: var(--shadow-light);
        }

        .reservations-list li strong {
            color: var(--primary-color);
            margin-right: 5px;
        }

        .reservations-list li span {
            flex-grow: 1; /* Permite que el texto ocupe espacio */
        }

        .loading-message, .no-reservations {
            text-align: center;
            font-style: italic;
            color: var(--secondary-color);
            padding: 20px;
            font-size: 1.1em;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            .container {
                padding: 20px;
                gap: 25px;
            }
            .header {
                flex-direction: column;
                text-align: center;
                align-items: center;
            }
            .header h1 {
                font-size: 1.8em;
            }
            .btn {
                width: 100%; /* Full width buttons on small screens */
            }
            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .form-group-full {
                grid-column: span 1;
            }
            .reservations-list li {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .reservations-list li span {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            section h2 {
                font-size: 1.4em;
            }
            .btn {
                padding: 8px 15px;
                font-size: 0.85em;
            }
            input[type="text"], input[type="number"], input[type="time"], select, textarea {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Reservas de Restaurante Xcaret</h1>
            <a href="admin.html" class="btn btn-info">Panel de Administración</a>
        </header>

        <section class="add-reservation-section">
            <h2>Hacer una Nueva Reserva</h2>
            <form id="reservationForm" class="form-grid">
                <div class="form-group">
                    <label for="room">Número de Habitación:</label>
                    <input type="number" id="room" placeholder="Ej. 1234" min="1000" max="9999" required>
                </div>
                <div class="form-group">
                    <label for="guest">Su Nombre:</label>
                    <input type="text" id="guest" placeholder="Ej. Ana García" required>
                </div>
                <div class="form-group">
                    <label for="place">Restaurante:</label>
                    <select id="place" required>
                        <option value="">Seleccione un restaurante</option>
                        <option value="El Patio">El Patio</option>
                        <option value="Bluewater">Bluewater</option>
                        <option value="Bordeaux">Bordeaux</option>
                        <option value="Himitsu">Himitsu</option>
                        <option value="Hibachi">Hibachi</option>
                        <option value="El Olio">El Olio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="time">Hora de Reserva:</label>
                    <input type="time" id="time" required>
                </div>
                <div class="form-group">
                    <label for="pax">Cantidad de Personas:</label>
                    <input type="number" id="pax" min="1" value="1" required>
                </div>
                <div class="form-group form-group-full">
                    <label for="comment">Comentario (Opcional):</label>
                    <textarea id="comment" rows="3" placeholder="Alergias, peticiones especiales, etc."></textarea>
                </div>
                <div class="form-group form-group-full">
                    <button type="submit" class="btn btn-primary">Confirmar Reserva</button>
                </div>
            </form>
        </section>

        <section class="current-reservations-section">
            <h2 id="reservationsHeader">Reservas para Hoy: <span id="todayDate"></span></h2>
            <div class="reservations-list">
                <ul id="reservationsList">
                    </ul>
                <p id="loadingMessage" class="loading-message">Cargando reservas...</p>
                <p id="noReservationsMessage" class="no-reservations" style="display:none;">No hay reservas para hoy.</p>
            </div>
        </section>
    </div>

    <script type="module">
        // Importar las funciones que necesitas de los SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        // Importante: Asegúrate de importar getDatabase y las funciones necesarias para la base de datos
        import { getDatabase, ref, push, set, onValue, remove, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Tu configuración de Firebase (DEBE SER LA MISMA QUE EN admin.html)
        const firebaseConfig = {
            apiKey: "AIzaSyALR-b68phh_u92V3rw9B9Ei7FcexU2xc8",
            authDomain: "proyectos17-98695.firebaseapp.com",
            projectId: "proyectos17-98695",
            storageBucket: "proyectos17-98695.firebasestorage.app",
            messagingSenderId: "951673973410",
            appId: "1:951673973410:web:4bc355e825cf86308645fb",
            measurementId: "G-6YK06W16FZ"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Opcional: Agrega un console.log para verificar si la base de datos se inicializó
        console.log("Firebase Database initialized:", database);

        document.addEventListener('DOMContentLoaded', () => {
            const reservationForm = document.getElementById('reservationForm');
            const reservationsList = document.getElementById('reservationsList');
            const todayDateSpan = document.getElementById('todayDate');
            const loadingMessage = document.getElementById('loadingMessage');
            const noReservationsMessage = document.getElementById('noReservationsMessage');

            // --- Funciones de Utilidad de Fecha y Hora ---

            function getTodayDateString() {
                const today = new Date();
                // Formatear a YYYY-MM-DD para que coincida con la estructura de Firebase
                // Asegurar que la fecha sea en la zona horaria de Punta Cana (GMT-4) si es necesario.
                // Para simplificar y asegurar que coincida con el lado del admin, usaremos ISOString y slice.
                // Para una precisión total de zona horaria local sin complicar, se puede crear una fecha 'local':
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function getFormattedDate(dateString) {
                if (!dateString) return 'Fecha desconocida';
                try {
                    // Añadir 'T12:00:00' para evitar problemas de zona horaria con fechas ISO al crear la Date object.
                    const date = new Date(dateString + 'T12:00:00');
                    if (isNaN(date.getTime())) {
                        return dateString;
                    }
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    return date.toLocaleDateString('es-ES', options);
                } catch (e) {
                    console.error("Error formatting date:", dateString, e);
                    return dateString;
                }
            }

            function convertTo12HourFormat(time24h) {
                if (!time24h) return '';
                const [hours, minutes] = time24h.split(':');
                const hour = parseInt(hours, 10);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const displayHour = hour % 12 || 12; // 0 becomes 12 for 12 AM/PM
                return `${displayHour}:${minutes} ${ampm}`;
            }

            // --- Lógica de la Aplicación ---

            const today = getTodayDateString();
            todayDateSpan.textContent = getFormattedDate(today);

            // Listener para el formulario de reservas
            reservationForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const room = document.getElementById('room').value;
                const guest = document.getElementById('guest').value;
                const place = document.getElementById('place').value;
                const time = document.getElementById('time').value;
                const pax = parseInt(document.getElementById('pax').value, 10);
                const comment = document.getElementById('comment').value;

                // Validación simple de entrada
                if (!room || !guest || !place || !time || !pax) {
                    alert('Por favor, complete todos los campos obligatorios.');
                    return;
                }
                // Validar que el número de habitación sea de 4 dígitos
                if (room.length !== 4 || isNaN(room) || parseInt(room, 10) < 1000 || parseInt(room, 10) > 9999) {
                    alert('Por favor, ingrese un número de habitación válido de 4 dígitos (ej. 1000-9999).');
                    return;
                }

                // Obtener el timestamp actual para ordenar y como ID único
                const timestamp = new Date().getTime();

                const newReservation = {
                    room: room,
                    guest: guest,
                    place: place,
                    time: time,
                    pax: pax,
                    comment: comment,
                    validator: 'Web User', // Indicador de que fue agregada por el usuario web
                    timestamp: timestamp,
                    date: today // La fecha de hoy
                };

                try {
                    // Guardar en dailyReservations bajo el nodo de la fecha de hoy
                    const reservationRef = ref(database, `dailyReservations/${today}`);
                    await push(reservationRef, newReservation); // push genera una ID única
                    alert('¡Reserva realizada con éxito!');
                    reservationForm.reset(); // Limpiar el formulario
                } catch (error) {
                    console.error("Error al guardar la reserva:", error);
                    alert("Hubo un error al procesar su reserva. Por favor, intente de nuevo.");
                }
            });

            // Leer reservas para el día actual
            // Escucha cambios en las reservas de la fecha actual
            onValue(ref(database, `dailyReservations/${today}`), (snapshot) => {
                const reservations = snapshot.val();
                displayReservations(reservations);
            }, (error) => {
                console.error("Error al cargar las reservas:", error);
                loadingMessage.style.display = 'none';
                noReservationsMessage.textContent = 'Error al cargar las reservas.';
                noReservationsMessage.style.display = 'block';
            });

            // Función para mostrar las reservas
            function displayReservations(reservations) {
                reservationsList.innerHTML = ''; // Limpiar la lista actual
                loadingMessage.style.display = 'none';

                if (!reservations) {
                    noReservationsMessage.style.display = 'block';
                    return;
                }

                noReservationsMessage.style.display = 'none';
                const reservationsArray = [];
                for (const key in reservations) {
                    reservationsArray.push({ id: key, ...reservations[key] });
                }

                // Ordenar por hora de reserva
                reservationsArray.sort((a, b) => a.time.localeCompare(b.time));

                reservationsArray.forEach(res => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span><strong>Habitación:</strong> ${res.room}</span>
                        <span><strong>Comensal:</strong> ${res.guest}</span>
                        <span><strong>Restaurante:</strong> ${res.place}</span>
                        <span><strong>Hora:</strong> ${convertTo12HourFormat(res.time)}</span>
                        <span><strong>PAX:</strong> ${res.pax}</span>
                        ${res.comment ? `<span><strong>Comentario:</strong> ${res.comment}</span>` : ''}
                    `;
                    reservationsList.appendChild(listItem);
                });
            }

            // --- Lógica de Archivo Automático de Reservas Antiguas ---
            // Esta función se ejecuta una vez al cargar la página para limpiar datos antiguos
            async function archiveOldReservations() {
                const todayDate = new Date(getTodayDateString() + 'T00:00:00'); // Fecha de hoy a medianoche

                // Obtener todas las fechas con reservas en dailyReservations
                const dailyReservationsRef = ref(database, 'dailyReservations');
                const snapshot = await get(dailyReservationsRef);
                const dailyReservations = snapshot.val();

                if (dailyReservations) {
                    for (const dateKey in dailyReservations) {
                        if (dailyReservations.hasOwnProperty(dateKey)) {
                            const reservationDate = new Date(dateKey + 'T00:00:00'); // Convertir la fecha de la DB a objeto Date a medianoche

                            // Si la fecha de la reserva es anterior a hoy
                            if (reservationDate < todayDate) {
                                console.log(`Archiving reservations for date: ${dateKey}`);
                                const reservationsToArchive = dailyReservations[dateKey];

                                // Mover todas las reservas de esa fecha a archivedReservations
                                await set(ref(database, `archivedReservations/${dateKey}`), reservationsToArchive)
                                    .then(() => {
                                        // Una vez movidas, eliminarlas de dailyReservations
                                        return remove(child(dailyReservationsRef, dateKey));
                                    })
                                    .then(() => {
                                        console.log(`Reservations for ${dateKey} successfully moved to archives.`);
                                    })
                                    .catch(error => {
                                        console.error(`Error archiving reservations for ${dateKey}:`, error);
                                    });
                            }
                        }
                    }
                }
            }

            // Ejecutar la función de archivo al cargar la página
            archiveOldReservations();

            // Opcional: Ejecutar la función de archivo periódicamente si la página se mantiene abierta
            // setInterval(archiveOldReservations, 24 * 60 * 60 * 1000); // Cada 24 horas

        });
    </script>
</body>
</html>
